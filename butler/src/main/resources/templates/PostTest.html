<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Post Details</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .preview-container {
            display: flex;
            flex-wrap: wrap;
        }
        .preview {
            margin: 10px;
        }
        .preview img {
            max-width: 150px;
            max-height: 150px;
        }
    </style>
</head>
<body>
<h1>Post Details</h1>
<form action="/page/post/dto/test" method="post" enctype="multipart/form-data">
    <input id="userIdx" name="userIdx" type="number" placeholder="user idx">
    <input id="title" name="title" type="text" placeholder="title">
    <input id="content" name="content" type="text" placeholder="content">

    <div id="image-inputs">
        <input type="file" name="postImgFiles" class="image-file" placeholder="Image File">
    </div>
    <button type="button" id="add-image-btn">+ Add Image</button>

    <div class="preview-container" id="image-previews"></div>

    <div id="tag-inputs">
        <input type="text" name="postTagList" placeholder="tag">
    </div>
    <button type="button" id="add-tag-btn">+ Add Tag</button>

    <div id="map" style="width:100%;height:350px;"></div>
    <p><em>지도를 클릭해주세요!</em></p>
    <div id="clickLatlng"></div>
    <input id="latitude" name="latitude" type="text" hidden>
    <input id="longitude" name="longitude" type="text" hidden>

    <input type="submit" value="Submit">
</form>
<script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=fbeace6c942e2a7c9dd0a0a1217724dd"></script>

<script>
    $(document).ready(function() {
        $('#add-image-btn').click(function() {
            $('#image-inputs').append('<input type="file" name="postImgFiles" class="image-file" placeholder="Image File">');
        });

        $('#add-tag-btn').click(function() {
            $('#tag-inputs').append('<input type="text" name="postTagList" placeholder="tag">');
        });

        $(document).on('change', '.image-file', function() {
            const files = this.files;
            const previewContainer = $('#image-previews');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = $('<img>').attr('src', e.target.result);
                    const preview = $('<div>').addClass('preview').append(img);
                    previewContainer.append(preview);
                };

                reader.readAsDataURL(file);
            }
        });
    });

    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude,
                lon = position.coords.longitude;

            var locPosition = new kakao.maps.LatLng(lat, lon);
            map.setCenter(locPosition);
        });
    } else {
        console.log("Geolocation을 지원하지 않는 브라우저입니다.");
    }

    var marker = new kakao.maps.Marker({
        position: map.getCenter()
    });
    marker.setMap(map);

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        var latlng = mouseEvent.latLng;
        marker.setPosition(latlng);

        var message = '클릭한 위치의 위도는 ' + latlng.getLat() + ' 이고, 경도는 ' + latlng.getLng() + ' 입니다';
        var resultDiv = document.getElementById('clickLatlng');
        resultDiv.innerHTML = message;

        document.getElementById("latitude").value = latlng.getLat();
        document.getElementById("longitude").value = latlng.getLng();
    });
</script>
</body>
</html>
